<!--
 Polymer Custom Element representing peer in Puppet Opperational Transformation communication Visualization
 -->
<!-- Import Polymer -->
<link rel="import" href="../bower_components/polymer/polymer.html">
<!-- dependencies-->
<link rel="import" href="../bower_components/core-collapse/core-collapse.html">

<!-- Define your custom element -->
<polymer-element name="potv-peer" attributes="name json localVersion remoteVersion localVersionName remoteVersionName">
<template>
<style>
 :host{
    display: block;
    min-height: 20px;
    padding: 19px;
    margin-bottom: 20px;
    background-color: #f5f5f5;
    border: 1px solid #e3e3e3;
    border-radius: 4px;
    -webkit-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.05);
    box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.05);
 }
 h2{
    font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
    font-weight: 500;
    color: rgb(255,203,0);
    font-size: 28px;
    line-height: 42px;
    margin: -8px 0 4px;
 }
 ::content>*{
    display: inline-block;
 }
 ::content>.potv-processed{
    transform: scale(0.8);
    /*float: left;*/
 }
 ul{
    list-style: none;
    padding-left: 10px;
 }
 h4,h5{
    cursor: pointer;
    margin-bottom: 2px;
 }
 #queue,#history{
    display: block;
    margin-bottom: 20px;
    border: 1px solid #e3e3e3;
    border-radius: 4px;
    -webkit-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.05);
    box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.05);

 }
/*core-collapse{
    overflow: visible;
} 
.core-collapse-closed{
    overflow:   hidden;
}*/
</style>
  <h2>{{name}}</h2>
  <ul>
    <li>Local version: {{localVersion}}</li>
    <li>Acknowledged remote version: {{remoteVersion}}</li>
  </ul>
  <h4 on-click="{toggleQueue}}">Queue</h4>
  <core-collapse id="queue" allowOverflow opened>
    <content select=".potv-queue"></content>
  </core-collapse>
  <h5 on-click="{{toggleHistory}}">History</h5>
  <core-collapse id="history" allowOverflow opened>
        <content select=".potv-processed"></content>
  </core-collapse>
  Processing:
  <content></content>



</template>

    <script>
        Polymer('potv-peer', {
            name: "",
            queue: null,
            // Fires when an instance of the element is created
            created: function() {
                this.queue = [];
            },

            // Fires when the elementâ€™s initial set of children and siblings are guaranteed to exist
            domReady: function() {},

            // Fires when the "<polymer-element>" has been fully prepared
            ready: function() {},

            // Fires when the element was inserted into the document
            attached: function() {},

            // Fires when the element was removed from the document
            detached: function() {},

            // Fires when an attribute was added, removed, or updated
            attributeChanged: function(attr, oldVal, newVal) {},

//             jsonChanged: function(event){
//               var ops = event.detail.action;
//               var operationElement = document.createElement("potv-operation");
//               operationElement.classList.add("bob")
//               this.$.bob.localVersion++;
// // debugger
//               operationElement.json = new ot.JSONPatchOperation([ops], this.$.bob.localVersion, this.$.bob.remoteVersion,"_ServerVersion", "_ClientVersion$");
//               this.$.response.appendChild( operationElement );

//               this.$.bobDiagram.goRightClient();
//               // debugger
//             },
            recieve: function(operationElement, diagram){
// debugger
                var versionDistance = operationElement.json.localRevision - this.remoteVersion;
                if( versionDistance < 1){
                    throw("This version was already applied");
                }
                if( versionDistance == 1){ // version is fine, apply patch, update version, and check queue
                    // computing
                    this.remoteVersion = operationElement.json.localRevision;
                    jsonpatch.apply(this.json, operationElement.json.ops);
                    //Visualization stuff
                        diagram.goLeft();
                        operationElement.classList.remove("potv-queue");
                        operationElement.classList.add("potv-processed")

                    // process next in queue if any
                    var nextInQueue = this.queue.shift();
                    nextInQueue && this.recieve(nextInQueue, diagram);
                } else { // add operation to queue
                    // computing
                    this.queue[ versionDistance -2 ]=(operationElement);
                    //Visualization stuff
                        console.log(this.queue);
                        operationElement.classList.add("potv-queue");
                }
                //Visualization stuff
                    this.appendChild(operationElement);

            },

            // ui only
            toggleHistory: function(){
                this.$.history.toggle();
            },
            toggleQueue: function(){
                this.$.queue.toggle();
            }
        });
    </script>

</polymer-element>